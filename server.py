# -*- coding: gbk -*-
import socket
import binascii
import sys
import datetime
import struct

NULL = ""
HOST = '0.0.0.0'
PORT = 8300
CODE = "ASCII"
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.bind((HOST, PORT))
s.listen(5)


def dataSwitch(data):
    str1 = ''
    str2 = ''
    while data:
        str1 = data[0:2]
        s = int(str1, 16)
        str2 += struct.pack('B', s)
        data = data[2:]
    return str2


if __name__ == "__main__":
    print 'Server start at: %s:%s' % (HOST, PORT)
    print 'wait for connection...'

    while True:
        conn, addr = s.accept()
        print 'Connected by ', addr

        while True:
            try:
                if CODE == "HEX":
                    # input_data ="\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30\x30\x38\x34\x38\x30"
                    input_data = "\x00\x00\x00\xd4\x03\x01\x00\x00\x00\xca\x32\x33\x2c\x31\xe6\x97\xa5\xe8\x90\xa5\xe6\x8a\x95\x31\x30\x30\x2c\x31\x31\x3a\x33\x34\x38\x36\x20\x30\x30\x2c\x2c\x30\x31\x42\x36\xe4\xb8\x8a\xe4\xb8\x9a\xe6\xa0\x87\x34\x37\x2c\x31\x30\x3a\x30\x30\x3a\x30\x2d\x31\x34\x2c\x33\x30\x31\x31\x2c\xe5\xb9\xb4\xe6\xb5\xb7\xe6\x80\xa7\xe6\x8b\x8d\x37\x35\x31\x31\x3a\x30\x30\x2c\x30\x30\x30\x30\x2c\x38\x39\x20\x36\x32\x30\x37\xe5\xb8\x82\xe5\xae\xa2\xe5\x8d\x96\x35\x30\x30\x3a\x33\x30\x2c\x31\x31\x2c\x37\x3a\x38\x35\x32\x20\x30\x34\x2c\xe6\x9c\x88\xe4\xb8\xaa\xe8\xbd\xa6\xe4\xbc\x9a\x2c\x2c\x3a\x33\x30\x2c\x31\x31\x2c\x32\x2d\x33\x34\x31\x35\x20\x37\x30\x32\x32\xe4\xba\xba\xe9\xa2\x9d\x2c\x32\x31\x33\x30\x2c\x31\x31\x3a\x38\x30\x32\x30\x35\x30\x33\x20\x32\x31\x30\x33\xe9\x9d\x9e\xe5\xba\xa6\x31\x34\x30\x30\x2c\x31\x31\x3a\x32\x34\x31\x33\x3a\x30\x30\x30"
                    print "raw:" + input_data
                    # print "pack:"+dataSwitch(input_data)
                    print "unhex:" + binascii.unhexlify(input_data)
                    conn.send(binascii.unhexlify(input_data))

                if CODE == "ASCII":
                    # cmd = raw_input("Please input msg:")
                    input_data1 = "\x00\x00\x00\xd4\x03\x01\x00\x00\x00\xca"
                    input_data2 = "23,1日营投100,11:3486 00,,01B6上业标47,10:00:0-14,3011,年海性拍7511:00,0000,89 6207市客卖500:30,11,7:852 04,月个车会,,:30,11,2-3415 7022人额,2130,11:8020503 2103非度1400,11:2413:000"
                    cmd = "\x00\x00\x00\xd4\x03\x01\x00\x00\x00\xca\x32\x33\x2c\x31\xe6\x97\xa5\xe8\x90\xa5\xe6\x8a\x95\x31\x30\x30\x2c\x31\x31\x3a\x33\x34\x38\x36\x20\x30\x30\x2c\x2c\x30\x31\x42\x36\xe4\xb8\x8a\xe4\xb8\x9a\xe6\xa0\x87\x34\x37\x2c\x31\x30\x3a\x30\x30\x3a\x30\x2d\x31\x34\x2c\x33\x30\x31\x31\x2c\xe5\xb9\xb4\xe6\xb5\xb7\xe6\x80\xa7\xe6\x8b\x8d\x37\x35\x31\x31\x3a\x30\x30\x2c\x30\x30\x30\x30\x2c\x38\x39\x20\x36\x32\x30\x37\xe5\xb8\x82\xe5\xae\xa2\xe5\x8d\x96\x35\x30\x30\x3a\x33\x30\x2c\x31\x31\x2c\x37\x3a\x38\x35\x32\x20\x30\x34\x2c\xe6\x9c\x88\xe4\xb8\xaa\xe8\xbd\xa6\xe4\xbc\x9a\x2c\x2c\x3a\x33\x30\x2c\x31\x31\x2c\x32\x2d\x33\x34\x31\x35\x20\x37\x30\x32\x32\xe4\xba\xba\xe9\xa2\x9d\x2c\x32\x31\x33\x30\x2c\x31\x31\x3a\x38\x30\x32\x30\x35\x30\x33\x20\x32\x31\x30\x33\xe9\x9d\x9e\xe5\xba\xa6\x31\x34\x30\x30\x2c\x31\x31\x3a\x32\x34\x31\x33\x3a\x30\x30\x30"

                    # cmd = input_data1+input_data2
                    print "unhex:" + binascii.hexlify(cmd)
                    print "len:"
                    print len(cmd)
                    print len(binascii.hexlify(cmd))
                    conn.send(cmd)

                data = conn.recv(65535)
                print data

            except Exception, e:
                print e
                print "There is error! Waiting for connection..."
                break

            # conn.send("server received you message.")
            # conn.close()
